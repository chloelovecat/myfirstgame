<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>小貓貓養成記 🐱🌈</title>
<style>
:root {
  --bg1: #fdfbff;
  --bg2: #e8f0ff;
  --panel: rgba(255,255,255,0.9);
  --accent: #ff9fc4;
  --grid: #e1e6f0;
}
html,body{
  height:100%;margin:0;font-family:'Noto Sans TC',system-ui;
  background:linear-gradient(160deg,var(--bg1),var(--bg2));
  color:#333;overflow:hidden;
}
.wrap{
  display:flex;gap:20px;padding:20px;align-items:flex-start;justify-content:center;flex-wrap:wrap;
}
#game{
  position:relative;
  background:var(--panel);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,0.08);
  padding:10px;
}
canvas{display:block;border-radius:10px;background:#fff;touch-action:none;}
.ui{
  min-width:250px;
  background:var(--panel);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,0.08);
  padding:16px;
  max-width:300px;
}
h1{margin:0 0 8px;font-size:20px;color:#222;text-align:center;}
.muted{color:#666;font-size:14px;text-align:center;}
.bigscore{font-size:36px;font-weight:600;text-align:center;margin:8px 0;}
.btn{
  padding:10px 14px;margin:4px;border:none;border-radius:8px;
  background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;font-size:15px;
  transition:0.2s;
}
.btn:hover{opacity:0.9;}
select{padding:6px 8px;border-radius:6px;border:1px solid #ccc;}
.legend{margin-top:12px;padding:10px;background:#f8f9fb;border-radius:10px;font-size:14px;line-height:1.5;}
.legend strong{display:block;margin-bottom:6px;text-align:center;}
footer{margin-top:10px;font-size:12px;text-align:center;color:#667;}
.overlay{
  position:absolute;left:0;top:0;width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
}
.overlay .card{
  background:rgba(255,255,255,0.95);
  padding:20px 28px;border-radius:14px;text-align:center;
  box-shadow:0 8px 30px rgba(0,0,0,0.15);
}
#mobile-controls{
  display:none;margin-top:10px;text-align:center;
}
.dpad{
  display:inline-grid;
  grid-template-columns:repeat(3,50px);
  grid-template-rows:repeat(3,50px);
  gap:6px;
  justify-content:center;
}
.dpad button{
  background:#e2e8f0;border:none;border-radius:12px;
  font-size:24px;cursor:pointer;
  transition:0.1s;
}
.dpad button:active{background:#cbd5e1;}
@media (max-width:768px){
  .wrap{flex-direction:column;align-items:center;}
  .ui{width:90%;max-width:400px;}
  #mobile-controls{display:block;}
  canvas{width:90vw;height:90vw;}
}
</style>
</head>
<body>
<div class="wrap">
  <div id="game">
    <canvas id="c" width="600" height="600"></canvas>
    <div id="overlay" class="overlay" style="display:none">
      <div class="card">
        <h2>遊戲結束 😿</h2>
        <p>分數：<strong id="ov-score">0</strong></p>
        <button id="restartBtn" class="btn">重新開始</button>
      </div>
    </div>
  </div>

  <div class="ui">
    <h1>🐱 小貓貓養成記 🌈</h1>
    <div class="muted">控制：方向鍵 / WASD / 觸控鍵</div>
    <div class="bigscore" id="score">0</div>
    <div style="text-align:center;margin-top:10px;">
      <button id="pauseBtn" class="btn">暫停</button>
      <button id="stepBtn" class="btn" style="background:#10b981;">一步</button>
    </div>
    <div style="margin-top:8px;text-align:center;">
      <label>棋盤顏色：</label>
      <select id="theme">
        <option value="default">預設</option>
        <option value="gray">灰色</option>
        <option value="yellow">暖黃</option>
        <option value="blue">藍色</option>
      </select>
    </div>
    <div id="legendBox" class="legend" style="display:none;">
      <strong>🎁 道具效果</strong>
      <div id="legendList"></div>
      <div id="starStatus" style="margin-top:8px;color:#e11d48;font-weight:bold;display:none;">✨ 無敵中！</div>
    </div>
    <footer>🐟 2s 🪨 3s 🥫 7s 🌈 10s</footer>
    <div id="mobile-controls">
      <div class="dpad">
        <div></div><button data-dir="up">⬆️</button><div></div>
        <button data-dir="left">⬅️</button><div></div><button data-dir="right">➡️</button>
        <div></div><button data-dir="down">⬇️</button><div></div>
      </div>
    </div>
  </div>
</div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const scoreEl=document.getElementById('score');
const ovScore=document.getElementById('ov-score');
const overlay=document.getElementById('overlay');
const pauseBtn=document.getElementById('pauseBtn');
const stepBtn=document.getElementById('stepBtn');
const restartBtn=document.getElementById('restartBtn');
const themeSel=document.getElementById('theme');
const legendBox=document.getElementById('legendBox');
const legendList=document.getElementById('legendList');
const starStatus=document.getElementById('starStatus');
const gridCount=20;
const cell=600/gridCount;

let snake=[],dir={x:1,y:0},nextDir={x:1,y:0};
let fishes=[],rocks=[],cans=[],stars=[];
let score=0,paused=false,gameOver=false,stepOnce=false,hasStar=false;
let timers={};

const itemDescriptions={
  fish:'🐟 小魚：+1分，變長',
  can:'🥫 魚罐頭：+3分，長度加倍',
  rock:'🪨 石頭：變短（-2節）',
  star:'🌈 彩色星星：無敵（撞牆不死，吃石頭解除）'
};
const shownItems=new Set();
function showItemLegend(type){
  if(!shownItems.has(type)){
    shownItems.add(type);
    legendBox.style.display='block';
    const div=document.createElement('div');
    div.textContent=itemDescriptions[type];
    legendList.appendChild(div);
  }
}

function rndInt(n){return Math.floor(Math.random()*n);}
function occupied(x,y){
  for(const s of snake)if(s.x===x&&s.y===y)return true;
  for(const o of [...fishes,...rocks,...cans,...stars])if(o.x===x&&o.y===y)return true;
  return false;
}
function getFreeCell(){
  const arr=[];
  for(let x=0;x<gridCount;x++)for(let y=0;y<gridCount;y++)if(!occupied(x,y))arr.push({x,y});
  return arr.length?arr[rndInt(arr.length)]:null;
}
function spawnFish(){const p=getFreeCell();if(p){fishes.push(p);showItemLegend('fish');}}
function spawnRock(){const p=getFreeCell();if(p){rocks.push(p);showItemLegend('rock');}}
function spawnCan(){const p=getFreeCell();if(p){cans.push(p);showItemLegend('can');}}
function spawnStar(){const p=getFreeCell();if(p){stars.push(p);showItemLegend('star');}}

function drawEmoji(list,e){ctx.font=Math.floor(cell*0.7)+'px serif';ctx.textAlign='center';ctx.textBaseline='middle';for(const p of list)ctx.fillText(e,p.x*cell+cell/2,p.y*cell+cell/2);}
function drawSnake(){
  for(let i=0;i<snake.length;i++){
    const s=snake[i];
    if(i===snake.length-1){ctx.font=Math.floor(cell*0.6)+'px serif';ctx.fillText('🐱',s.x*cell+cell/2,s.y*cell+cell/2);}
    else{ctx.fillStyle=hasStar?'#ffe066':'#ffc7d2';ctx.fillRect(s.x*cell+2,s.y*cell+2,cell-4,cell-4);}
  }
}
function drawGrid(){
  ctx.clearRect(0,0,600,600);
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid');
  for(let i=0;i<=gridCount;i++){
    ctx.beginPath();ctx.moveTo(i*cell,0);ctx.lineTo(i*cell,600);ctx.stroke();
    ctx.beginPath();ctx.moveTo(0,i*cell);ctx.lineTo(600,i*cell);ctx.stroke();
  }
}

function step(){
  if(gameOver)return;if(paused&&!stepOnce)return;stepOnce=false;
  if((nextDir.x!==-dir.x||nextDir.y!==-dir.y))dir=nextDir;
  const head={...snake.at(-1)};head.x+=dir.x;head.y+=dir.y;
  if(head.x<0||head.x>=gridCount||head.y<0||head.y>=gridCount){
    if(hasStar){head.x=Math.max(0,Math.min(gridCount-1,head.x));head.y=Math.max(0,Math.min(gridCount-1,head.y));}
    else{return endGame();}
  }
  snake.push(head);
  let ate=false;
  for(let i=0;i<fishes.length;i++){if(fishes[i].x===head.x&&fishes[i].y===head.y){fishes.splice(i,1);score++;ate=true;break;}}
  for(let i=0;i<cans.length;i++){if(cans[i].x===head.x&&cans[i].y===head.y){cans.splice(i,1);score+=3;snake=snake.concat([...snake]);ate=true;break;}}
  for(let i=0;i<stars.length;i++){if(stars[i].x===head.x&&stars[i].y===head.y){stars.splice(i,1);hasStar=true;starStatus.style.display='block';ate=true;break;}}
  for(let i=0;i<rocks.length;i++){if(rocks[i].x===head.x&&rocks[i].y===head.y){rocks.splice(i,1);for(let k=0;k<2&&snake.length>1;k++)snake.shift();if(hasStar){hasStar=false;starStatus.style.display='none';}}}
  if(!ate)snake.shift();
  scoreEl.textContent=score;
}
function drawAll(){drawGrid();drawEmoji(fishes,'🐟');drawEmoji(cans,'🥫');drawEmoji(rocks,'🪨');drawEmoji(stars,'🌈');drawSnake();requestAnimationFrame(drawAll);}
function reset(){
  snake=[{x:10,y:10},{x:11,y:10},{x:12,y:10}];
  dir={x:1,y:0};nextDir={x:1,y:0};fishes=[];rocks=[];cans=[];stars=[];
  score=0;hasStar=false;starStatus.style.display='none';
  shownItems.clear();legendBox.style.display='none';legendList.innerHTML='';
  Object.values(timers).forEach(clearInterval);
  timers.fish=setInterval(spawnFish,2000);
  timers.rock=setInterval(spawnRock,3000);
  timers.can=setInterval(spawnCan,7000);
  timers.star=setInterval(spawnStar,10000);
  paused=false;gameOver=false;overlay.style.display='none';
}
function endGame(){gameOver=true;ovScore.textContent=score;overlay.style.display='flex';Object.values(timers).forEach(clearInterval);}
window.addEventListener('keydown',e=>{
  const k=e.key;if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D'].includes(k))e.preventDefault();
  if(k==='ArrowUp'||k==='w')nextDir={x:0,y:-1};
  if(k==='ArrowDown'||k==='s')nextDir={x:0,y:1};
  if(k==='ArrowLeft'||k==='a')nextDir={x:-1,y:0};
  if(k==='ArrowRight'||k==='d')nextDir={x:1,y:0};
  if(k===' '){paused=!paused;pauseBtn.textContent=paused?'繼續':'暫停';}
});
pauseBtn.onclick=()=>{paused=!paused;pauseBtn.textContent=paused?'繼續':'暫停';};
stepBtn.onclick=()=>{stepOnce=true;step();};
restartBtn.onclick=()=>{reset();};
themeSel.onchange=()=>{
  const v=themeSel.value;const r=document.documentElement;
  if(v==='gray'){r.style.setProperty('--bg1','#e9e9e9');r.style.setProperty('--bg2','#dcdcdc');r.style.setProperty('--grid','#ccc');}
  else if(v==='yellow'){r.style.setProperty('--bg1','#fffbea');r.style.setProperty('--bg2','#ffefb0');r.style.setProperty('--grid','#ffd97a');}
  else if(v==='blue'){r.style.setProperty('--bg1','#eaf6ff');r.style.setProperty('--bg2','#c8e1ff');r.style.setProperty('--grid','#b4d4ff');}
  else{r.style.setProperty('--bg1','#fdfbff');r.style.setProperty('--bg2','#e8f0ff');r.style.setProperty('--grid','#e1e6f0');}
};
reset();setInterval(()=>{if(!gameOver&&!paused)step();},150);drawAll();

// 行動版方向鍵
document.querySelectorAll('[data-dir]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const d=btn.dataset.dir;
    if(d==='up')nextDir={x:0,y:-1};
    if(d==='down')nextDir={x:0,y:1};
    if(d==='left')nextDir={x:-1,y:0};
    if(d==='right')nextDir={x:1,y:0};
  });
});
</script>
</body>
</html>
